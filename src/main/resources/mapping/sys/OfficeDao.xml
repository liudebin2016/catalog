<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jusfoun.catalog.dao.OfficeDao">

    <sql id="officeColumns">
        a.id,
        a.parent_id AS "parent.id",
        a.parent_ids,
        a.area_id AS "area.id",
        a.code,
        a.name,
        a.duty,
        a.sort,
        a.type,
        a.grade,
        a.address,
        a.zip_code,
        a.master,
        a.phone,
        a.fax,
        a.email,
        a.remarks,
        a.create_by AS "createBy.id",
        a.create_date,
        a.update_by AS "updateBy.id",
        a.update_date,
        a.del_flag,
        a.status,
        a.useable AS useable,
        a.primary_person AS "primaryPerson.id",
        a.deputy_person AS "deputyPerson.id",
        p.name AS "parent.name",
        ar.name AS "area.name",
        ar.parent_ids AS "area.parentIds",
        pp.name AS "primaryPerson.name",
        dp.name AS "deputyPerson.name"
    </sql>

    <sql id="officeJoins">
        LEFT JOIN sys_office p ON p.id = a.parent_id
        LEFT JOIN sys_area ar ON ar.id = a.area_id
        LEFT JOIN sys_user pp ON pp.id = a.primary_person
        LEFT JOIN sys_user dp ON dp.id = a.deputy_person
    </sql>

    <select id="get" resultType="Office">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.id = #{id}
    </select>

    <select id="findList" resultType="Office">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.del_flag = #{DEL_FLAG_NORMAL}
        <!-- 数据范围过滤 -->
        ${sqlMap.dsf}
        OR a.id = #{currentUser.office.id}
        ORDER BY a.code
    </select>

    <select id="findAllList" resultType="Office">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.del_flag = #{DEL_FLAG_NORMAL}
        ORDER BY a.code
    </select>

    <select id="findByParentIdsLike" resultType="Office">
        SELECT
        <include refid="officeColumns"/>
        FROM sys_office a
        <include refid="officeJoins"/>
        WHERE a.del_flag = #{DEL_FLAG_NORMAL} AND a.parent_ids LIKE #{parentIds}
        ORDER BY a.code
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_office(
        parent_id,
        parent_ids,
        area_id,
        code,
        name,
        duty,
        sort,
        type,
        grade,
        address,
        zip_code,
        master,
        phone,
        fax,
        email,
        create_by,
        create_date,
        update_by,
        update_date,
        remarks,
        del_flag,
        status,
        useable,
        primary_person,
        deputy_person
        ) VALUES (
        #{parent.id},
        #{parentIds},
        #{area.id},
        #{code},
        #{name},
        #{duty},
        #{sort},
        #{type},
        #{grade},
        #{address},
        #{zipCode},
        #{master},
        #{phone},
        #{fax},
        #{email},
        #{createBy.id},
        #{createDate},
        #{updateBy.id},
        #{updateDate},
        #{remarks},
        #{delFlag},
        #{status},
        #{useable},
        #{primaryPerson.id},
        #{deputyPerson.id}
        )
    </insert>

    <update id="update">
        UPDATE sys_office 
        <set >
	        <if test="name != null" >
	          name = #{name},
	        </if>
	        <if test="parent != null" >
	          parent_id = #{parent.id},
	        </if>
	        <if test="parentIds != null" >
	          parent_ids = #{parentIds},
	        </if>
	        <if test="area != null" >
	          area_id = #{area.id},
	        </if>
	        <if test="code != null" >
	          code = #{code},
	        </if>
	        <if test="duty != null" >
	          duty = #{duty},
	        </if>
	        <if test="sort != null" >
	          sort = #{sort},
	        </if>
        	<if test="type != null" >
	          type = #{type},
	        </if>
        	<if test="grade != null" >
	          grade = #{grade},
	        </if>
        	<if test="address != null" >
	          address = #{address},
	        </if>
        	<if test="zipCode != null" >
	          zip_code = #{zipCode},
	        </if>
        	<if test="master != null" >
	          master = #{master},
	        </if>
        	<if test="phone != null" >
	          phone = #{phone},
	        </if>
        	<if test="fax != null" >
	          fax = #{fax},
	        </if>
        	<if test="email != null" >
	          email = #{email},
	        </if>
        	<if test="createBy != null" >
	          create_by = #{createBy.id},
	        </if>
        	<if test="createDate != null" >
	          create_date = #{createDate},
	        </if>
        	<if test="updateBy != null" >
	          update_by = #{updateBy.id},
	        </if>
        	<if test="updateDate != null" >
	          update_date = #{updateDate},
	        </if>
        	<if test="remarks != null" >
	          remarks = #{remarks},
	        </if>
        	<if test="delFlag != null" >
	          del_flag = #{delFlag},
	        </if>
        	<if test="status != null" >
	          status = #{status},
	        </if>
        	<if test="useable != null" >
	          useable = #{useable},
	        </if>
        	<if test="primaryPerson != null" >
	          primary_person = #{primaryPerson.id},
	        </if>
        	<if test="deputyPerson != null" >
	          deputy_person = #{deputyPerson.id},
	        </if>
	        <if test="updateBy != null" >
		        update_by = #{updateBy.id},
		    </if>
	        <if test="updateDate != null" >
		        update_date = #{updateDate},
		    </if>
	    </set>
        WHERE id = #{id}
    </update>

    <update id="updateParentIds">
        UPDATE sys_office SET
        parent_id = #{parent.id},
        parent_ids = #{parentIds}
        WHERE id = #{id}
    </update>
    
    <update id="updateOfficeById" >
    	 UPDATE sys_office SET
    	 duty=#{param2}
    	 WHERE id= #{param1}
    </update>

    <update id="delete">
        UPDATE sys_office SET
        del_flag = #{DEL_FLAG_DELETE}
        WHERE id = #{id} OR parent_ids LIKE
        <if test="dbName == 'oracle'">'%,'||#{id}||',%'</if>
        <if test="dbName == 'mssql'">'%,'+#{id}+',%'</if>
        <if test="dbName == 'mysql'">CONCAT('%,', #{id}, ',%')</if>
    </update>
    
    <select id="findPageList" parameterType="Office">
    	select * from sys_office
    	<choose>
			<when test="page !=null and page.pageNo != null and page.pageSize != null">
				limit ${page.pageNo},${page.pageSize}
			</when>
			<otherwise>
				limit 0,3
			</otherwise>
		</choose>
    </select>

	<!-- 查询有效个数 -->
	<select id="getCount" resultType="java.lang.Long">
		select count(id)
		from sys_office
		where del_flag = 0
	</select>
	
	<!-- queryOffices -->
	<select id="queryOffices" parameterType="map" resultType="Office">
		SELECT id,name,duty
		FROM sys_office
		WHERE duty like CONCAT('%', #{duty}, '%')
		<if test="id != null" >
	       AND id = #{id}
	    </if>
	</select>
	<!-- 前端树 -->
	<select id="findByPid" resultType="com.jusfoun.catalog.vo.ETreeNode" parameterType="int">
		SELECT id,name as text FROM sys_office o 
		WHERE o.parent_id=#{pid}
	</select>
</mapper>